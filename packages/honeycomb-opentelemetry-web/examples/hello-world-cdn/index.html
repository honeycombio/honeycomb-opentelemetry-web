<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Honeycomb OpenTelemetry Web Distro</title>
  </head>
  <body>
    <ul id="spans-go-here"></ul>
    <section class="example-app">
      <header class="header">
        <h1>ðŸ‘‹ Hello World (CDN)</h1>
      </header>

      <button id="loadDadJoke">Get A Random Dad Joke</button>
      <div>
        <span id="dadJokeText"></span>
      </div>
      <div>
        <span>Session ID: <code id="sessionId">-</code></span>
      </div>
      <div>
        <span>Jokes remaining this session: <code id="jokesRemaining"></span>
      </div>
    </section>

    <!-- Scripts here. Don't remove â†“ -->
    <script src="../dist/umd/index.js"></script>
    <script>
      const configDefaults = {
        ignoreNetworkEvents: true,
      };

      // Your session logic is probably based on cookies or local storage.
      // But for this example, we will use a random ID generator and call 5 jokes a session.
      const getJokeCountSessionProvider = (MAX_JOKES = 5) => {
        let sessionId = null;
        let count = 0;
        const jokeLimit = MAX_JOKES;

        return {
          incrementJokeCount: () => {
            if (count >= MAX_JOKES) {
              const newSessionId = crypto.randomUUID();
              sessionId = newSessionId;
              count = 0;
              return;
            }
            count++;
          },
          currentJokeCount: () => count,
          jokeLimit: () => jokeLimit,
          getSessionId: () => {
            if (sessionId === null) {
              // Consider using from RandomIdGenerator from @opentelemetry/sdk-trace-base
              sessionId = crypto.randomUUID();
            }
            return sessionId;
          },
        };
      };

      const sessionProvider = getJokeCountSessionProvider();

      const updateJokeCount = () => {
          const jokesRemaining =  sessionProvider.jokeLimit() - sessionProvider.currentJokeCount();
        document.getElementById('jokesRemaining').innerText = jokesRemaining

      };

      const main = () => {
        const sdkOptions = {
          // defaults to sending to US instance of Honeycomb
          // endpoint: "https://api.eu1.honeycomb.io/v1/traces", // uncomment to send to EU instance
          apiKey: 'api-key', // Replace with your Honeycomb Ingest API Key
          serviceName: 'hny-web-distro-example:hello-world-cdn', // Replace with your application name. Honeycomb will name your dataset using this variable.
          debug: true,
          webVitalsInstrumentationConfig: {
            vitalsToTrack: ['CLS', 'FCP', 'INP', 'LCP', 'TTFB'],
            inp: {
              includeTimingsAsSpans: true,
            },
          },
          sessionProvider,
        };

        const instOpts = {
          // load custom configuration for xml-http-request instrumentation
          '@opentelemetry/instrumentation-xml-http-request': configDefaults,
          '@opentelemetry/instrumentation-fetch': configDefaults,
          '@opentelemetry/instrumentation-document-load': configDefaults,
        };

        const sdk = window.HNY.configureHoneycombSDK(
          sdkOptions,
          instOpts,
          'hello-world-cdn',
        );
        sdk.start();
        document.getElementById('sessionId').innerText = sdk.getSessionId();
        updateJokeCount();
        const buttonElement = document.getElementById('loadDadJoke');

        buttonElement.addEventListener('click', () => {
          const span = sdk.startSpan('getJoke');
          fetch('https://icanhazdadjoke.com/', {
            headers: {
              'content-type': 'application/json',
              accept: 'application/json',
            },
          })
            .then((res) => {
              const jsonPromise = res.json();
              return jsonPromise;
            })
            .then((data) => {
              console.log({ data });
              span.setAttribute('data.joke', data.joke);
              span.setAttribute('data.id', data.id);
              span.setAttribute('data.status', data.status);
              document.getElementById('dadJokeText').innerText = data.joke;
            })
            .finally(() => {
              span.end();
              sessionProvider.incrementJokeCount();
              document.getElementById('sessionId').innerText =
                sdk.getSessionId();
              updateJokeCount();
            })
            .catch((e) => {
              console.error(e);
            });
        });
      };

      main();
    </script>
  </body>
</html>
